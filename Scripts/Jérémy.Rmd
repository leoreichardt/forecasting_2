---
title: "forecast2"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(include = FALSE)
library(dplyr)
library(ggplot2)
library(tidyverse)
library(here)
library(lubridate)
library(knitr)
library(kableExtra)
library(readr)
library(magrittr)
library(forecast)

calendar <- read_csv("~/Desktop/4.2/forecasting/m5-forecasting-accuracy/calendar.csv")
sales_train_validation <- read_csv("~/Desktop/4.2/forecasting/m5-forecasting-accuracy/sales_train_validation.csv")
sell_prices <- read_csv("~/Desktop/4.2/forecasting/m5-forecasting-accuracy/sell_prices.csv")

sales_train_validation <- sales_train_validation %>% filter(store_id == "TX_1")
sell_prices <- sell_prices  %>% filter(store_id == "TX_1")
```

creating a new data frame with sales per day
```{r echo=FALSE}

ventes <- as.numeric()
for (i in 7:ncol(sales_train_validation)) {
  ventes[i] <- sum(sales_train_validation[ ,i])
}
ventes <- ventes[-c(1:6)]

## créer un vecteur correspondant à d_1 à d_1913
dates <- seq(as.Date("2011-01-29"), as.Date("2016-04-24"), by="days")

ventes_et_dates <- data.frame(ventes, dates)

ventes_et_dates$weekday = weekdays(ventes_et_dates$dates)
ventes_et_dates$month = month(ventes_et_dates$dates)
```

number of product per departement
```{r echo=FALSE}
sales_train_validation%>%group_by(dept_id)%>%count()
```

sales per day for one departement (FOODS_1 in this case)
```{r echo=FALSE}
dept_group_food<-sales_train_validation%>%group_by(dept_id)%>%filter(dept_id=="FOODS_1")

ventes_per_dept <- as.numeric()
for (i in 7:ncol(dept_group_food)) {
  ventes_per_dept[i] <- sum(dept_group_food[ ,i])
}
ventes <- ventes[-c(1:6)]


```

average sales per weekday
```{r echo=FALSE}
ventes_et_dates%>%
  group_by(weekday)%>%
  mutate(avg_sale = mean(ventes)) %>%
  ggplot()+
  geom_col(aes(x = weekday, y = avg_sale, color = weekday))+
  labs(x = "Weekday", y = "Average sales", size = 10)+labs(title = "Average sales per weekday") +
  theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 10))+
  theme(legend.position = "None")
```

average sales per month
```{r echo=FALSE}
ventes_et_dates%>%
  group_by(month)%>%
  mutate(avg_sale = mean(ventes)) %>%
  ggplot()+
  geom_col(aes(x = as.factor(month), y = avg_sale, color = month))+
  labs(x = "Month", y = "Average sales", size = 10)+labs(title = "Average sales per month") +
  theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 10))+
  theme(legend.position = "None")+
  scale_x_discrete(labels = c("January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"))
```

Sales per departement
```{r echo=FALSE}
sales_train_validation$Sales_per_product <- sales_train_validation %>% select(7:1919) %>% mutate() %>% rowSums()

sales_train_validation%>%
  group_by(dept_id)%>%
  mutate(sum_sales = sum(Sales_per_product))  %>%
  ggplot()+
  geom_col(aes(x = dept_id, y = sum_sales, color = dept_id))+
  labs(x = "departement ID", y = "Sum of sales", size = 10)+labs(title = "Sum of sales per departement") +
  theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 10)) +
  theme(legend.position = "None")
```

##joining `sell_prices`and `sales_train_validation` table
```{r include=FALSE}
#transpose the matrix
sales_calendar <- data.frame(t(sales_train_validation))

#create vector of date
y <- seq(as.Date("2011-01-23"), as.Date("2016-04-25"), by = "day")

#add date vector to sales_train_validation and reorder columns
sales_calendar$date <- y

sales_calendar <- sales_calendar[c(3050,1:3049)]

#join calendar and sales_train_validation
sales_calendar <- left_join(sales_calendar, calendar, by = "date")
```

*sell_price analysis*

Max, min and average price for each product
```{r}
price_TX1 <- sell_prices %>% 
  filter(store_id == "TX_1")

price_TX1 %>% 
  group_by(item_id) %>%
  summarise(max = max(sell_price), min = min(sell_price), avg = round(mean(sell_price), digits = 2)) %>%
  kable()
```

Evolution of prices over time
```{r}
#price avolution for one product in particular
price_TX1 %>%
  filter(item_id == "FOODS_3_794") %>% 
  ggplot(x, mapping = aes(wm_yr_wk, sell_price)) +
  geom_line() +
  labs(x = "weeks", y = "price", size = 10) +
  labs(title = "Evolution of prices through time")

#price evolution by departement
price_TX1 %>%
  mutate(category = substr(item_id, 1, 5)) %>%
  group_by(category, wm_yr_wk) %>%
  mutate(avg_price = mean(sell_price)) %>%
  ggplot() +
  geom_line(aes(wm_yr_wk, avg_price, color = category)) +
  labs(x = "weeks", y = "average prices", size = 10)+labs(title = "Evolution of prices through time by category")

```

