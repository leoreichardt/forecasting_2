---
title: "Exploratory analysis"
date: "4/20/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)
library(tidyverse)
library(ggseas)
library(kableExtra)
```


```{r data}
calendar <- read_csv("~/Documents/GitHub/forecasting_2/Data/calendar.csv")
sales_train_validation <- read_csv("~/Documents/GitHub/forecasting_2/Data/sales_train_validation.csv")
sell_prices <- read_csv("~/Documents/GitHub/forecasting_2/Data/sell_prices.csv")
```

## Plan
We are interested in predicting the sales of TX_1. Therefore we will mainly focus on this store.

calendar:
- List of event types
- Barplot. X axis = weekdays, Y axis = count(event)
- Barplot. X axis = event_type, Y axis = count(event)
- Time series. Y axis = count(event). Daily? Weekly? Monthly? Yearly? (will be usefull to compute correlation with time series about sales)
- Résumer dans une table le nombre d'events par semaine, mois, année pour chaque année

sell_prices:
- Min, Max, Mean price for TX_1
- Compared to the ohter stores?

sales_train_validation:
- First we need to join the sell prices
- Sales per product (#, $ or %) for TX_1
- Sales per category (#, $ or %) for TX_1
- Total sales (# and $) for TX_1
- Barplot. X axis = c(all, TX, TX_1), Y axis = % of sales
- Time series of sales for TX_1
* autoplot()
* ggseasonplot()
* ggsubseriesplot()
* gglagplot()
* ggacf()
* checkresiduals()
- qplot using ts of sales and ts of events? (any correlation?)

#-----------------------------------------------------------------------------------------------

## Calendar

List of event types
```{r}
calendar %>% select(event_type_1) %>% unique() %>% drop_na() %>%
kable(caption ="List of event types") %>% 
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  scroll_box(width = "100%") 
```

Barplot. X axis = weekdays, Y axis = count(event)
```{r}
x <- calendar %>% filter(!is.na(event_name_1) | !is.na(event_name_2)) %>% group_by(weekday) %>% count()
  
x$weekday <- ordered(x$weekday, levels=c("Monday", "Tuesday", "Wednesday", "Thursday", 
"Friday", "Saturday", "Sunday"))
  
x %>%  
    ggplot(aes(x = weekday, y = n)) +
    geom_col(fill = "#fb1c4c") +
    geom_text(aes(label = n)) +
    theme_bw() +
  labs(title = "Number of events per weekday") +
  theme(plot.title = element_text(hjust = 0.5)) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
          axis.title = element_blank())
```

## sell_prices





## sales_train_validation

Time series of sales for TX_1 (#)
```{r}
## Sales for TX_1
sales_TX1 <- sales_train_validation %>% filter(store_id == "TX_1")

## Total sales per day for TX_1
Sales_per_day_TX1 <- sales_TX1 %>% select(7:1919) %>% colSums()

## add column with total sales per product (TX_1)
sales_TX1 <- sales_TX1 %>% mutate(tot_sales = rowSums(.[7:1919])) 

## total sales for TX_1
sum3 <- sales_TX1$tot_sales %>% sum()

sell_prices_TX1 <- sell_prices %>% filter(store_id == "TX_1")

calendar2 <- calendar[1:1913, 1:7] %>% mutate(Sales_per_day_TX1)

calendar2 %>% 
  ggplot(aes(x = date, y=Sales_per_day_TX1)) +
  geom_line() +
  theme_light() +
  labs(title = "Sales per day (#)",
      x = "Time",
      y = "Number of sales") +
  theme(plot.title = element_text(hjust = 0.5))
```


Time series decomposition
```{r}
ggsdc(calendar2, aes(x = date, y=Sales_per_day_TX1),
         method = "stl", s.window = 13, frequency = 365,
         facet.titles = c("The original series", "The underlying trend", 
                          "Regular seasonal patterns", "All the randomness left")) +
      geom_line() +
  theme_light() +
  labs(title = "Sales per day",
      x = "Time",
      y = "Number of sales") +
  theme(plot.title = element_text(hjust = 0.5))
# What is a good value for s.window?
```
